

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="canonical" href="http://blog.zsoldosp.eu/2016/02/01/warnings-warn-some-deprecationwarning-gotchas/" />
    
  <meta name="description" content="warnings.warn - some DeprecationWarning gotchas is about deprecation, executable documentation, gotcha, python, software, til, and warnings" />

  <title>warnings.warn - some DeprecationWarning gotchas | Do. Reflect. Learn. Repeat!</title>
  <meta name="author" content="Peter Zsoldos">

  <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="http://feeds.feedburner.com/zsoldosp" />
  <link rel="shortcut icon" href="/favicon.ico">
  <link href="/css/reset.css" media="screen" rel="stylesheet" type="text/css" /> 
  <link href="/css/main.css" media="screen" rel="stylesheet" type="text/css" /> 
  <link href="/css/pygment-tango.css" media="screen" rel="stylesheet" type="text/css" /> 
  <script type="text/javascript">
  const posthogConsentKey = 'posthog-consent';
  const consentPosthogConsentStore = window.localStorage;
  const consentFormId = 'posthog-consent-form';
  const consentOK = 'OK'
  const noConsent = 'DNT'
  function consent(isOK) {
  	consentPosthogConsentStore[posthogConsentKey] = isOK;
	posthogInit()
	updateConsentUI()
  }

  function updateConsentUI() {
	if(posthogHasChosen()) {
		const form = document.querySelector('#' + consentFormId);
		if (form) {
			form.parentNode.removeChild(form);
		}
		if(hasConsent()) {
			setConsentText('You consented to analytics cookies')
		} else {
			setConsentText('You opted out from analytics cookies')
		}
	} else {
		setConsentText('No tracking happens until you consent to it using the below form')
		addConsentForm()
	}
  }
  function addConsentForm() {
	const inner = document.querySelector('#content .inner');
	const form = document.createElement("form");
	form.id = consentFormId;
	form.innerHTML = '<p>I would like to know which pages/articles are seen the most so I can improve the content of the site. For that, I chose the GDPR compliant <a href="https://posthog.com">posthog.com</a>, and it uses cookies if you consent.</p><p><input type=button onclick="consent(consentOK)" value="Cookies are OK, write more artcles"> <input type="button" onclick="consent(noConsent)" value="Do Not Track, please"></p>';
	inner.insertBefore( form, inner.firstChild);
  }
  function posthogHasChosen() {
  	return consentPosthogConsentStore[posthogConsentKey] !== undefined;
  }
  function hasConsent() {
  	return consentPosthogConsentStore[posthogConsentKey] === consentOK;
  }
  function posthogInit() {
     !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys onSessionId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    posthog.init('phc_hc0BgsP5GW7bfHwdwV30CE3ezvLpitrbAscVGdNbONr',{api_host:'https://eu.posthog.com'})

  }

  function setConsentText(msg) {
  	const node = document.querySelector('#posthog-chosen')
	const sentences = node.innerText.split('.')
	sentences[0] = msg
	node.innerText = sentences.join('.');
  }

  if(hasConsent()) { posthogInit(); document}
  document.addEventListener('DOMContentLoaded', updateConsentUI)
  </script>

</head>

  <body>
    <div id="header">
      <div class="inner">
                <ul>
                    <li><a href="https://twitter.com/zsepi">@zsepi</a></li>
                    <li><a href="/about.html">about me</a></li>
                    <li><a href="/category/software/">software</a></li>
                    <li><a href="/category/outdoors/">outdoors</a></li>
                </ul>
                <h1><a href="/">Do. Reflect. Learn. Repeat!</a></h1>
                <h2>Excercises in public learning</h2>
		<p id="posthog-chosen" style="font-size: 70%; text-align: right; font-style: italic">This site doesn't use cookies, and doesn't collect data about your visit. The hosting provider likely records operational data. For more info, email me hello at zsoldosp.eu</p>
      </div>
    </div>
    <div id="content">
        <div class="inner">
            
  





<div itemscope itemtype="http://schema.org/Article" class="post">
    <h3><a itemprop="name" href="/2016/02/01/warnings-warn-some-deprecationwarning-gotchas/">warnings.warn - some DeprecationWarning gotchas</a></h3>
  
    <div itemprop="articleBody" class="body">
        <h2 id="deprecationwarnings"><code>DeprecationWarning</code>s</h2>
<p>It's a good practice to gradually deprecate one's library's API, so that 
users get advance warning of coming changes. The built in way to
do so is Python's <a href="https://docs.python.org/3.5/library/warnings.html"><code>warnings</code> module</a></p>
<pre><code>import warnings

if __name__ == '__main__':
    warnings.warn('deprecation', DeprecationWarning)
</code></pre>
<h2 id="by-default-they-are-not-reported">By default, they are not reported!</h2>
<p>However, if I run this code, there is no output.</p>
<pre><code>$ python3.5 demo.py
$ echo $?
0
</code></pre>
<p>The <a href="https://docs.python.org/3.5/library/warnings.html#default-warning-filters">documentation on default warning filters</a> explains: </p>
<blockquote>
<p>By default, Python installs several warning filters, which can be overridden by the command-line 
options passed to <code>-W</code> and calls to <code>filterwarnings()</code>.</p>
<ul>
<li><code>DeprecationWarning</code> and <code>PendingDeprecationWarning</code>, and <code>ImportWarning</code> are ignored.</li>
<li><code>BytesWarning</code> is ignored unless the <code>-b</code> option is given once or twice; in this case
   this warning is either printed (<code>-b</code>) or turned into an exception (<code>-bb</code>).</li>
<li><code>ResourceWarning</code> is ignored unless Python was built in debug mode.
</li>
</ul>
</blockquote>
<h2 id="forcing-defaults-from-the-command-line-makes-them-reported">Forcing defaults from the command line makes them reported</h2>
<p>However, if we force the <a href="https://docs.python.org/3.5/using/cmdline.html#cmdoption-W"><em>default</em> warning behavior from the command line</a>,
we get the warnings - even though theoretically we only specified <em>how often</em> the warnings
should be reported, not <em>which</em> warnings to be reported!</p>
<pre><code>$ python3.5 -W d demo.py
demo.py:4: DeprecationWarning: deprecation
  warnings.warn('warning', DeprecationWarning)
$ echo $?
0
</code></pre>
<p>Before reading the docs, I suspected the operating system maintainers didn't want to 'spam'
the end users of their systems with python library warnings while going about their daily 
tasks, but apparently this is built into python itself.</p>
<h2 id="so-how-should-i-deprecate-things">So how should I deprecate things?</h2>
<p>I'm a big fan of <a href="/2010/08/executable-documentation.html">executable documentation</a>, but this might be one of those cases
where good old fashioned documentation might be more effective, as we can't expect users of
our library to run with warnings enabled.</p>
<p>I would still leave in these deprecations for the project's developers as well as for the
pedant users of the library.</p>
<h2 id="checking-against-deprecations-of-our-dependencies">Checking against deprecations of our dependencies</h2>
<p>That's easier, as we own that code. I would run my builds and tests with <code>-W d</code> at the very
least, but I would like to try to run with <code>-W error</code>. Except that I don't want to fail the
build if one of my dependencies is using deprecated apis, so probably I would just have a
custom <code>main.py</code> where I would explicitly set and reset my warning filters. E.g.: updating
the above demo code would give me the following:</p>
<pre><code>import warnings
import os

if os.environ.get('TEST', '0') == '1':
    warnings.filterwarnings(module='.*', action='ignore')
    warnings.filterwarnings(module=__name__, action='error')

if __name__ == '__main__':
    warnings.warn('deprecation', DeprecationWarning)
</code></pre>
<p>&nbsp;</p>
<pre><code>$ TEST=1 python3.5 demo.py
Traceback (most recent call last):
  File "demo.py", line 8, in &lt;module&gt;
    warnings.warn('deprecation', DeprecationWarning)
DeprecationWarning: deprecation
$ echo $?
1
</code></pre>
<p>I yet have to test how feasible it is when our library supports multiple versions of a 
dependent library, e.g.: <a href="https://www.djangoproject.com/">Django</a>, but my gut feeling is that it should be doable</p>
<h3 id="beware-of-the-ordering-of-warning-filters">Beware of the ordering of warning filters</h3>
<p>If in the above example we got the order reversed, then our own <code>DeprecationWarning</code>s would
be ignored too!</p>
<pre><code>if os.environ.get('TEST', '0') == '1':
    warnings.filterwarnings(module=__name__, action='error')
    warnings.filterwarnings(module='.*', action='ignore')
</code></pre>
    </div>
    <div class="meta">
        <p>What do you think? I would love if you would <strong>leave a comment</strong> - drop me an <strong>email</strong> at <strong><a href="mailto:hello@zsoldosp.eu">hello@zsoldosp.eu</a></strong>, tell me on <a href="https://twitter.com/intent/tweet?url=http://blog.zsoldosp.eu/2016/02/01/warnings-warn-some-deprecationwarning-gotchas/&text=@zsepi, in response to warnings.warn - some DeprecationWarning gotchas">Twitter</a>!
    </div>
    <div class="meta">
        <p>Posted on <a href="/2016/02/01/warnings-warn-some-deprecationwarning-gotchas/" itemprop="datePublished" content="2016-02-01T11:17">February 01, 2016 at 11:17 AM</a> in <span class="blog_post_categories"><a href='/category/deprecation/'>deprecation</a>, <a href='/category/executable-documentation/'>executable documentation</a>, <a href='/category/gotcha/'>gotcha</a>, <a href='/category/python/'>python</a>, <a href='/category/software/'>software</a>, <a href='/category/til/'>til</a>, <a href='/category/warnings/'>warnings</a></span> by <a href="/about.html" rel="author" itemprop="author" itemscope itemtype="http://schema.org/Person" itemprop="name">Peter</a></p>
        <p>Share this post if you liked it - on 
<a href="http://digg.com/submit?url=http://blog.zsoldosp.eu/2016/02/01/warnings-warn-some-deprecationwarning-gotchas/">Digg</a>,
<a href="http://facebook.com/sharer.php?u=http://blog.zsoldosp.eu/2016/02/01/warnings-warn-some-deprecationwarning-gotchas/">Facebook</a>, 
<a href="https://plus.google.com/share?url=http://blog.zsoldosp.eu/2016/02/01/warnings-warn-some-deprecationwarning-gotchas/">Google+</a>, 
<a href="http://reddit.com/submit?url=http://blog.zsoldosp.eu/2016/02/01/warnings-warn-some-deprecationwarning-gotchas/&title=warnings.warn - some DeprecationWarning gotchas">reddit</a>,
or
<a href="https://twitter.com/intent/tweet?url=http://blog.zsoldosp.eu/2016/02/01/warnings-warn-some-deprecationwarning-gotchas/&text=warnings.warn - some DeprecationWarning gotchas&via=zsepi">Twitter</a>

 
    </p>
    </div>
    

<form style="border:1px solid #ccc;padding:3px;text-align:center;" action="http://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open('http://feedburner.google.com/fb/a/mailverify?uri=zsoldosp', 'popupwindow', 'scrollbars=yes,width=550,height=520'); _gaq.push(['_trackEvent', 'blog', 'Email Subscribe']); return true">
    <p>Your email address</p>
    <p><input type="text" style="width:340px" name="email"/></p>
    <input type="hidden" value="zsoldosp" name="uri"/>
    <input type="hidden" name="loc" value="en_US"/>
    <input type="submit" value="Subscribe to get new posts via email!" />
</form>

        </div>
    </div>
        <div id="footer" class="clearfix">
            <div class="inner">
                <div class="about">
                    <h3><a href="/about.html">About Me</a></h3>
                    
                    <a href="/about.html"><img src="/img/me_small.jpg" alt="ME" /></a>
                    <div>
                        I'm a software developer and outdoors enthusiast among other things. <a href="/about.html">Read more</a>
                    </div>
                </div>
            <div class="about">
                <p>Powered by <a href="http://www.blogofile.com">Blogofile</a></p>
                <p>Template from <a href="https://github.com/jamesyu/jamesyu_jekyll_template">James Yu's Jekyll template</a>

<p>This is a personal weblog. The opinions expressed here are my own and not necessarily reflect those of my - current or former - employers'.

<p>All posts - unless noted otherwise - are licensed under a Creative Commons Attribution-Noncommercial-Share Alike 3.0 License.

<a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="license"><img alt="Creative Commons License" style="border-width: 0pt;" src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a></p>
                
            </div>
        </div>
    </body> 
</html>

